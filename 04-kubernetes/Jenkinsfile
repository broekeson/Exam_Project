pipeline {
    agent any

    environment {
        KUBECONFIG = '/var/lib/jenkins/workspace/altschool/01-terraform/kubeconfig.yaml'
    }

    stages {
        stage('deploy-web-app') {
          steps {
              dir('04-kubernetes') {
              sh '''
              kubectl apply -f 02-k8s-web-app/a-namespace.yaml
              kubectl apply -f 02-k8s-web-app/secret.yaml
              kubectl apply -f 02-k8s-web-app/configMap.yaml
              kubectl apply -f 02-k8s-web-app/db-deployment.yaml
              kubectl apply -f 02-k8s-web-app/db-service.yaml
              kubectl apply -f 02-k8s-web-app/web-app-deployment.yaml
              kubectl apply -f 02-k8s-web-app/web-app-service.yaml
              '''
              }
          }
      }
        stage('deploy-sock-shop') {
          steps {
              dir('04-kubernetes') {
              sh '''
              kubectl apply -f 01-k8s-sock-app/complete-demo.yaml
              kubectl apply -f 01-k8s-sock-app/manifests-monitoring/
              '''
              }
          }
       }
        stage('Install cert-manager') {
          steps {
            sh '''
            helm repo add jetstack https://charts.jetstack.io
            helm repo update
            kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.11.0/cert-manager.crds.yaml
            helm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --version v1.11.0
            '''
          } 
        }
         stage('Create ClusterIssuer') {
          steps {
              dir('04-kubernetes') {
              sh '''
              kubectl apply -f ingress-controller/cluster-issuer.yaml
              kubectl apply -f ingress-controller/nginx-svc.yaml
              kubectl apply -f ingress-controller/monitoring.yaml
              kubectl apply -f ingress-controller/sock-shop-ingress.yaml
              kubectl apply -f ingress-controller/web-app-ingress.yaml
                '''
                }
            }
         }
    }
}
