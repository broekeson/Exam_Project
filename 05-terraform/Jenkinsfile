pipeline {
    agent any
    environment {
       DO_TOKEN = credentials('do_token')
    }
    stages {
       stage('Get External IP') {
      steps {
        script {
          def externalIp = sh(returnStdout: true, script: 'kubectl get service -n ingress-nginx -o jsonpath="{.status.loadBalancer.ingress[0].ip}"').trim()
          echo "External IP: ${externalIp}"
        }
      }
    }
       stage('DNS Setup') {
          steps {
              dir('05-terraform/terraform') {
                sh '''
                terraform init
                terraform apply -auto-approve -var DO_TOKEN=${DO_TOKEN} -var external_ip=${externalIp}
                '''
              }
          }
        }
    }

    post {
       success {
        build 'deploy'
       }
    }
}