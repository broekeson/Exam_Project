pipeline {
    agent any
    environment {
       DO_TOKEN = credentials('do_token')
       KUBECONFIG = '/var/lib/jenkins/workspace/altschool/01-terraform/kubeconfig.yaml'
    }
    stages {
       stage('Get External IP') {
        steps {
          dir('05-terraform/terraform') {
           def nginx_ip = sh(returnStdout: true, script: "kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}'")
            sh '''
            terraform init
            terraform apply  -var nginx_ip=$nginx_ip -var DO_TOKEN=${DO_TOKEN} -auto-approve
            '''
           }  
         }
       }
    }

    post {
       success {
        build 'deploy'
       }
    }
}